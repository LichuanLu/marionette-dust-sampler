Backbone.ComputedFields=function(e,t){var i=function(e){this.model=e,this._computedFields=[],this.initialize()};return i.VERSION="0.0.5",t.extend(i.prototype,{initialize:function(){t.bindAll(this),this._lookUpComputedFields(),this._bindModelEvents(),this._wrapJSON()},_lookUpComputedFields:function(){for(var e in this.model.computed){var t=this.model.computed[e];t&&(t.set||t.get)&&this._computedFields.push({name:e,field:t})}},_bindModelEvents:function(){t.each(this._computedFields,function(e){var i=e.name,n=e.field,o=t.bind(function(){var e=this._computeFieldValue(n);this.model.set(i,e,{skipChangeEvent:!0})},this),d=t.bind(function(e,t,o){if((!o||!o.skipChangeEvent)&&n.set){var d=this._dependentFields(n.depends);t=t||this.model.get(i),n.set.call(this.model,t,d),this.model.set(d,o)}},this);this._thenDependentChanges(n.depends,o),this._thenComputedChanges(i,d),this._isModelInitialized()&&o()},this)},_isModelInitialized:function(){return!t.isEmpty(this.model.attributes)},_thenDependentChanges:function(e,i){t.each(e,function(e){"string"==typeof e&&this.model.on("change:"+e,i),"function"==typeof e&&e.call(this.model,i)},this)},_thenComputedChanges:function(e,t){this.model.on("change:"+e,t)},_wrapJSON:function(){this.model.toJSON=t.wrap(this.model.toJSON,this._toJSON)},_toJSON:function(e){var i=e.call(this.model),n=t.reduce(this._computedFields,function(e,t){return t.field.toJSON===!1&&e.push(t.name),e},[]);return t.omit(i,n)},_computeFieldValue:function(e){if(e&&e.get){var t=this._dependentFields(e.depends);return e.get.call(this.model,t)}},_dependentFields:function(e){return t.reduce(e,function(e,t){return e[t]=this.model.get(t),e},{},this)}}),i}(Backbone,_);